name: Deploy App to EC2

on:
  workflow_call:

jobs:
  deploy_app:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
      STACK_NAME: php-app-stack
      IMAGE_TAG: latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/cf-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Send SSM deployment command
        run: |
          set -euo pipefail
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters Name=tag:Name,Values=PHPAppEC2 \
            --query 'Reservations[0].Instances[0].InstanceId' \
            --output text)

          RDS_HOST=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --query "Stacks[0].Outputs[?OutputKey=='RDSHost'].OutputValue" \
            --output text)

          echo "üîÑ Sending command to EC2 via SSM..."
          COMMANDS=$(cat <<EOF
          [
            "sh -c '
              DB_USER=\$(aws ssm get-parameter --name /phpapp/db_username --with-decryption --output text --query Parameter.Value --region us-east-1) &&
              DB_PASS=\$(aws ssm get-parameter --name /phpapp/db_password --with-decryption --output text --query Parameter.Value --region us-east-1) &&
              aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $REPO_URI &&
              docker pull $REPO_URI:$IMAGE_TAG &&
              docker stop php_app || true &&
              docker rm php_app || true &&
              docker run -d --name php_app --network monitor-net -p 80:80 \
                -e DB_NAME=optimy_db \
                -e DB_HOST=$RDS_HOST \
                -e DB_USER=\$DB_USER \
                -e DB_PASS=\$DB_PASS \
                $REPO_URI:$IMAGE_TAG
            '"
          ]
          EOF
          )


          CMD_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy latest Docker image with env vars" \
            --parameters commands="$COMMANDS" \
            --region "$AWS_REGION" \
            --query 'Command.CommandId' \
            --output text)

          echo "‚è≥ Waiting for SSM command [$CMD_ID] to execute..."
          sleep 20  # give the agent time to process

          OUTPUT=$(aws ssm get-command-invocation \
            --command-id "$CMD_ID" \
            --instance-id "$INSTANCE_ID" \
            --region "$AWS_REGION" \
            --output json)

          STATUS=$(echo "$OUTPUT" | jq -r '.Status')
          STDOUT=$(echo "$OUTPUT" | jq -r '.StandardOutputContent')
          STDERR=$(echo "$OUTPUT" | jq -r '.StandardErrorContent')

          echo "::group::üìù SSM Command Output"
          echo "$STDOUT"
          echo "::endgroup::"

          echo "::group::‚ùóSSM Command Error"
          echo "$STDERR"
          echo "::endgroup::"

          echo "::group::üì¶ Raw Command Payload"
          echo "$OUTPUT"
          echo "::endgroup::"

          if [[ "$STATUS" != "Success" ]]; then
            echo "‚ùå SSM command failed with status: $STATUS"
            exit 1
          else
            echo "‚úÖ SSM command completed successfully"
          fi

      - name: Tar and base64 encode monitoring files
        run: |
          echo "üìÅ Creating staging folder: deploy/tmp"
          mkdir -p deploy/tmp

          echo "üìÑ Copying docker-compose.monitoring.yml..."
          if [ ! -f docker/docker-compose.monitoring.yml ]; then
            echo "‚ùå docker-compose.monitoring.yml NOT FOUND"
            exit 1
          fi
          cp docker/docker-compose.monitoring.yml deploy/tmp/
          echo "‚úÖ docker-compose.monitoring.yml copied"

          echo "üìÑ Copying agent.alloy.template..."
          if [ ! -f monitoring/agent.alloy.template ]; then
            echo "‚ùå agent.alloy.template NOT FOUND"
            exit 1
          fi
          cp monitoring/agent.alloy.template deploy/tmp/
          echo "‚úÖ agent.alloy.template copied"

          echo "üì¶ Creating tarball..."
          tar -cvzf deploy/monitoring.tar.gz -C deploy/tmp .
          echo "‚úÖ Tarball created: deploy/monitoring.tar.gz"

          echo "üìê Tarball contents:"
          tar -tvf deploy/monitoring.tar.gz

          echo "üîê Encoding tarball to base64 (single-line)"
          base64 -w 0 deploy/monitoring.tar.gz > deploy/monitoring.tar.gz.b64
          echo "‚úÖ Base64 encoding complete"

          echo "üìÑ Base64 preview (first 300 chars):"
          head -c 300 deploy/monitoring.tar.gz.b64; echo

          echo "üîÅ Exporting FILE_CONTENT to GitHub ENV"
          echo "FILE_CONTENT=$(cat deploy/monitoring.tar.gz.b64)" >> "$GITHUB_ENV"

      - name: Deploy monitoring stack to EC2 via SSM
        run: |
          echo "üì° Resolving EC2 instance by tag Name=PHPAppEC2..."
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters Name=tag:Name,Values=PHPAppEC2 \
            --query 'Reservations[0].Instances[0].InstanceId' \
            --output text)

          echo "üì¶ Sending deployment command via SSM..."
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy Alloy monitoring" \
            --parameters 'commands=[
              "set -euo pipefail",

              "echo ‚úÖ Creating folders",
              "mkdir -p /opt/monitoring",

              "echo ‚úÖ Decoding tarball...",
              "echo '"${FILE_CONTENT}"' | base64 -d > /opt/monitoring/monitoring.tar.gz",

              "echo ‚úÖ Extracting...",
              "tar -xzf /opt/monitoring/monitoring.tar.gz -C /opt/monitoring/",
              "[[ -f /opt/monitoring/agent.alloy.template ]] || { echo ‚ùå Missing template; exit 1; }",

              "echo ‚úÖ Installing Docker Compose V2",
              "mkdir -p /usr/local/lib/docker/cli-plugins",
              "curl -sSL https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64 -o /usr/local/lib/docker/cli-plugins/docker-compose",
              "chmod +x /usr/local/lib/docker/cli-plugins/docker-compose",
              "ln -sf /usr/local/lib/docker/cli-plugins/docker-compose /usr/local/bin/docker-compose",

              "echo ‚úÖ Creating shared Docker network if not exists...",
              "docker network ls | grep -q monitor-net || docker network create monitor-net",

              "echo ‚úÖ Fetching Grafana token from SSM...",
              "export GRAFANA_BEARER_TOKEN=$(aws ssm get-parameter --name /phpapp/grafana-api-key --with-decryption --query Parameter.Value --output text --region us-east-1)",

              "echo ‚úÖ Generating agent.alloy config...",
              "rm -rf /opt/monitoring/agent.alloy",
              "envsubst < /opt/monitoring/agent.alloy.template > /opt/monitoring/agent.alloy",
              "cat /opt/monitoring/agent.alloy",

              "echo üîÑ Restarting monitoring stack",
              "docker compose -f /opt/monitoring/docker-compose.monitoring.yml down || true",
              "docker compose -f /opt/monitoring/docker-compose.monitoring.yml up -d",

              "echo üßπ Cleaning up temp files",
              "rm -f /opt/monitoring/monitoring.tar.gz",
              
              "echo ‚úÖ All done!"
            ]' \
            --region "$AWS_REGION" \
            --output text \
            --query 'Command.CommandId')

          echo "ü™™ Command ID: $COMMAND_ID"
          echo "‚è≥ Waiting for command to finish..."

          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --region "$AWS_REGION"

          echo "üìÑ Output:"
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --region "$AWS_REGION" \
            --output text \
            --query 'StandardOutputContent'

          echo "‚ùå Error (if any):"
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --region "$AWS_REGION" \
            --output text \
            --query 'StandardErrorContent'

          STATUS=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --region "$AWS_REGION" \
            --query 'Status' \
            --output text)

          if [[ "$STATUS" != "Success" ]]; then
            echo "‚ùå SSM command failed with status: $STATUS"
            exit 1
          fi  