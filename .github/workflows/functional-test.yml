name: Functional Test

on:
  workflow_call:

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
      STACK_NAME: php-app-stack
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/cf-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Get EC2 IP and run Playwright tests
        run: |
          PUBLIC_IP=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query "Stacks[0].Outputs[?OutputKey=='EC2PublicIP'].OutputValue" --output text)
          echo "APP_URL=http://$PUBLIC_IP" >> $GITHUB_ENV
          cd tests
          npm ci
          npx playwright install --with-deps
          npm test