name: Deploy Infrastructure

on:
  workflow_call:

jobs:
  infra:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
      STACK_NAME: php-app-stack
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/cf-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Import EC2 key from SSM if missing
        run: |
          if ! aws ec2 describe-key-pairs --key-names php-app-key 2>/dev/null; then
            aws ssm get-parameter --name "/phpapp/public-key" --region "$AWS_REGION" --query 'Parameter.Value' --output text > public-key.txt
            aws ec2 import-key-pair --key-name php-app-key --public-key-material fileb://public-key.txt --region "$AWS_REGION"
          fi

      - name: Deploy CloudFormation Stack
        run: |
          aws cloudformation deploy \
            --template-file cloudformation/ec2-rds-alb.yml \
            --stack-name "$STACK_NAME" \
            --capabilities CAPABILITY_NAMED_IAM \
            --parameter-overrides KeyName=php-app-key \
            --no-fail-on-empty-changeset
